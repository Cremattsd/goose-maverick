{% extends 'base.html' %}
{% block title %}Home | Goose Maverick{% endblock %}

{% block content %}
<div id="chat-container">
  <h1 class="chat-title">CRE Chat Bot</h1>
  <div id="messages" class="messages-box"></div>
  <div id="input-container">
    <input type="text" id="message-input" placeholder="Type your command..." />
    <div id="chat-buttons">
      <button onclick="sendMessage()" title="Send Message"><i class="fas fa-paper-plane"></i></button>
      <button onclick="toggleVoiceInput()" id="voice-btn" title="Voice Input"><i class="fas fa-microphone"></i></button>
      <button onclick="speakLastResponse()" id="speak-btn" title="Hear Response"><i class="fas fa-volume-up"></i></button>
    </div>
  </div>
  <div id="voice-status"></div>
</div>

<style>
  #chat-container {
    background: #2a2d3e;
    padding: 2rem;
    border-radius: 12px;
    max-width: 800px;
    margin: 2rem auto;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
  }

  .chat-title {
    font-size: 1.75rem;
    font-weight: bold;
    color: #fff;
    margin-bottom: 1rem;
  }

  .messages-box {
    background: #1c1f2a;
    border-radius: 8px;
    padding: 1rem;
    height: 300px;
    overflow-y: auto;
    color: #f0f0f0;
    margin-bottom: 1rem;
  }

  .message {
    margin-bottom: 0.75rem;
  }

  .user-message {
    color: #00d1b2;
  }

  .bot-message {
    color: #ffd369;
  }

  #input-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  #message-input {
    flex-grow: 1;
    padding: 0.75rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
  }

  #chat-buttons button {
    background: #444;
    border: none;
    padding: 0.65rem 0.75rem;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    font-size: 1.1rem;
  }

  #chat-buttons button:hover {
    background: #666;
  }

  #voice-status {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #ccc;
  }
</style>

<script>
  let recognition;
  let isListening = false;
  let lastBotResponse = '';

  window.onload = function () {
    fetch('/get-messages', {
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('token')
      }
    })
    .then(res => res.json())
    .then(data => {
      const messagesDiv = document.getElementById('messages');
      data.messages.forEach(msg => addMessage(msg.sender, msg.message));
    });

    document.getElementById('message-input').addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });
  };

  function addMessage(sender, message) {
    const div = document.createElement('div');
    div.className = 'message ' + (sender === 'user' ? 'user-message' : 'bot-message');
    div.textContent = `${sender === 'bot' ? 'Bot' : 'You'}: ${message}`;
    document.getElementById('messages').appendChild(div);
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    if (sender === 'bot') lastBotResponse = message;
  }

  function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if (!message) return;
    addMessage('user', message);
    input.value = '';

    fetch('/ask', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('token')
      },
      body: JSON.stringify({ query: message })
    })
    .then(res => res.json())
    .then(data => {
      addMessage('bot', data.response || 'No response');
      fetch('/save-message', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ sender: 'bot', message: data.response })
      });
    });
  }

  function toggleVoiceInput() {
    const voiceBtn = document.getElementById('voice-btn');
    const voiceStatus = document.getElementById('voice-status');

    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert('Browser does not support speech recognition.');
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.onresult = event => {
      const transcript = event.results[0][0].transcript;
      document.getElementById('message-input').value = transcript;
      voiceStatus.textContent = 'Heard: ' + transcript;
      sendMessage();
    };
    recognition.onend = () => {
      isListening = false;
      voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
      voiceStatus.textContent = '';
    };
    recognition.onerror = e => {
      voiceStatus.textContent = 'Error: ' + e.error;
      isListening = false;
      voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
    };

    if (!isListening) {
      recognition.start();
      isListening = true;
      voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
      voiceStatus.textContent = 'Listening...';
    } else {
      recognition.stop();
    }
  }

  function speakLastResponse() {
    if (!lastBotResponse) return;
    const utterance = new SpeechSynthesisUtterance(lastBotResponse);
    utterance.lang = 'en-US';
    window.speechSynthesis.speak(utterance);
  }
</script>
{% endblock %}
