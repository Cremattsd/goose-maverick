{% extends 'base.html' %}
{% block title %}Home | Goose Maverick{% endblock %}

{% block content %}
<div id="chat-container">
  <h1>CRE Chat Bot</h1>
  <div id="messages"></div>
  <div id="input-container">
    <input type="text" id="message-input" placeholder="Type your command...">
    <button onclick="sendMessage()" title="Send Message"><i class="fas fa-paper-plane"></i></button>
    <button onclick="toggleVoiceInput()" id="voice-btn" title="Voice Input"><i class="fas fa-microphone"></i></button>
    <button onclick="speakLastResponse()" id="speak-btn" title="Hear Response"><i class="fas fa-volume-up"></i></button>
  </div>
  <div id="voice-status"></div>
</div>

<style>
  /* same CSS as before, not repeated here for space */
</style>

<script>
  let recognition;
  let isListening = false;
  let lastBotResponse = '';

  window.onload = function () {
    fetch('/get-messages', {
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('token')
      }
    })
    .then(res => res.json())
    .then(data => {
      const messagesDiv = document.getElementById('messages');
      data.messages.forEach(msg => addMessage(msg.sender, msg.message));
    });
  };

  function addMessage(sender, message) {
    const div = document.createElement('div');
    div.className = 'message ' + (sender === 'user' ? 'user-message' : 'bot-message');
    div.textContent = `${sender === 'bot' ? 'Bot' : 'You'}: ${message}`;
    document.getElementById('messages').appendChild(div);
    if (sender === 'bot') lastBotResponse = message;
  }

  function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if (!message) return;
    addMessage('user', message);
    input.value = '';

    fetch('/ask', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('token')
      },
      body: JSON.stringify({ query: message })
    })
    .then(res => res.json())
    .then(data => {
      addMessage('bot', data.response || 'No response');
      fetch('/save-message', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ sender: 'bot', message: data.response })
      });
    });
  }

  function toggleVoiceInput() {
    const voiceBtn = document.getElementById('voice-btn');
    const voiceStatus = document.getElementById('voice-status');

    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert('Browser does not support speech recognition.');
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.onresult = event => {
      const transcript = event.results[0][0].transcript;
      document.getElementById('message-input').value = transcript;
      voiceStatus.textContent = 'Heard: ' + transcript;
      sendMessage();
    };
    recognition.onend = () => {
      isListening = false;
      voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
      voiceStatus.textContent = '';
    };
    recognition.onerror = e => {
      voiceStatus.textContent = 'Error: ' + e.error;
      isListening = false;
      voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
    };

    if (!isListening) {
      recognition.start();
      isListening = true;
      voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
      voiceStatus.textContent = 'Listening...';
    } else {
      recognition.stop();
    }
  }

  function speakLastResponse() {
    if (!lastBotResponse) return;
    const utterance = new SpeechSynthesisUtterance(lastBotResponse);
    utterance.lang = 'en-US';
    window.speechSynthesis.speak(utterance);
  }

  document.getElementById('message-input').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
  });
</script>
{% endblock %}
