{% extends 'base.html' %}

{% block title %}Home | Goose Maverick{% endblock %}

{% block head %}
<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    min-height: 100vh;
    margin: 0;
    padding-top: 80px;
  }

  #chat-wrapper {
    flex-grow: 1;
    width: 100%;
    max-width: 1000px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding: 30px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  h1 {
    text-align: center;
    color: #00ddeb;
    font-size: 24px;
    margin-bottom: 20px;
  }

  #messages {
    flex-grow: 1;
    max-height: 600px;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .message {
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 15px;
    max-width: 80%;
    word-wrap: break-word;
  }

  .user-message {
    background: linear-gradient(135deg, #00ddeb, #007bff);
    color: white;
    margin-left: auto;
    margin-right: 5%;
  }

  .bot-message {
    background: linear-gradient(135deg, #ff6f61, #ff3e5a);
    color: white;
    margin-right: auto;
    margin-left: 5%;
  }

  #input-container {
    display: flex;
    gap: 10px;
    align-items: center;
    background: rgba(255, 255, 255, 0.05);
    padding: 10px;
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  #message-input {
    flex-grow: 1;
    padding: 10px;
    background: transparent;
    border: none;
    color: white;
    outline: none;
    font-size: 14px;
  }

  #message-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  button {
    background: none;
    border: none;
    color: #00ddeb;
    font-size: 18px;
    cursor: pointer;
    padding: 8px;
    transition: color 0.3s ease;
  }

  button:hover {
    color: #ff6f61;
  }

  #voice-status {
    color: rgba(255, 255, 255, 0.7);
    text-align: center;
    margin-top: 10px;
    font-size: 12px;
  }
</style>
{% endblock %}

{% block content %}
<div id="chat-wrapper">
  <h1>CRE Chat Bot</h1>
  <div id="messages"></div>
  <div id="input-container">
    <input type="text" id="message-input" placeholder="Type your command...">
    <button onclick="sendMessage()" title="Send Message"><i class="fas fa-paper-plane"></i></button>
    <button onclick="toggleVoiceInput()" id="voice-btn" title="Voice Input"><i class="fas fa-microphone"></i></button>
    <button onclick="speakLastResponse()" id="speak-btn" title="Hear Response"><i class="fas fa-volume-up"></i></button>
  </div>
  <div id="voice-status"></div>
</div>

<script>
  let recognition;
  let isListening = false;
  let lastBotResponse = '';

  window.onload = function () {
    fetch('/get-messages', {
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('token')
      }
    })
    .then(response => response.json())
    .then(data => {
      const messagesDiv = document.getElementById('messages');
      data.messages.forEach(msg => {
        addMessage(msg.sender, msg.message);
      });
    });
  };

  function addMessage(sender, message) {
    const messagesDiv = document.getElementById('messages');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message ' + (sender === 'user' ? 'user-message' : 'bot-message');
    msgDiv.textContent = `${sender}: ${message}`;
    messagesDiv.appendChild(msgDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    if (sender === 'bot') lastBotResponse = message;
  }

  function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if (message) {
      addMessage('user', message);
      fetch('/save-message', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ sender: 'user', message: message })
      });

      fetch('/ask', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ query: message })
      })
      .then(response => response.json())
      .then(data => {
        addMessage('bot', data.response);
        fetch('/save-message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ sender: 'bot', message: data.response })
        });
      });
      input.value = '';
    }
  }

  function toggleVoiceInput() {
    const voiceBtn = document.getElementById('voice-btn');
    const voiceStatus = document.getElementById('voice-status');

    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert('Sorry, your browser does not support speech recognition.');
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    if (!isListening) {
      recognition.start();
      isListening = true;
      voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
      voiceStatus.textContent = 'Listening...';

      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('message-input').value = transcript;
        voiceStatus.textContent = 'Heard: ' + transcript;
        sendMessage();
      };

      recognition.onend = function () {
        isListening = false;
        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        voiceStatus.textContent = '';
      };

      recognition.onerror = function (event) {
        voiceStatus.textContent = 'Error: ' + event.error;
        isListening = false;
        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
      };
    } else {
      recognition.stop();
      isListening = false;
      voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
      voiceStatus.textContent = '';
    }
  }

  function speakLastResponse() {
    if (!lastBotResponse) {
      alert('No bot response to speak.');
      return;
    }

    if (!('speechSynthesis' in window)) {
      alert('Sorry, your browser does not support text-to-speech.');
      return;
    }

    const utterance = new SpeechSynthesisUtterance(lastBotResponse);
    utterance.lang = 'en-US';
    window.speechSynthesis.speak(utterance);
  }

  document.getElementById('message-input').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') sendMessage();
  });
</script>
{% endblock %}
