{% extends 'base.html' %}

{% block title %}Home | Goose Maverick{% endblock %}

{% block content %}
<div id="chat-container">
    <h1>CRE Chat Bot</h1>
    <div id="messages"></div>
    <div id="input-container">
        <input type="text" id="message-input" placeholder="Type your command...">
        <button onclick="sendMessage()" title="Send Message"><i class="fas fa-paper-plane"></i></button>
        <button onclick="toggleVoiceInput()" id="voice-btn" title="Voice Input"><i class="fas fa-microphone"></i></button>
        <button onclick="speakLastResponse()" id="speak-btn" title="Hear Response"><i class="fas fa-volume-up"></i></button>
    </div>
    <div id="voice-status"></div>
</div>

<script>
    let recognition;
    let isListening = false;
    let lastBotResponse = '';

    window.onload = function () {
        fetch('/get-messages', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        })
        .then(response => response.json())
        .then(data => {
            const messagesDiv = document.getElementById('messages');
            data.messages.forEach(msg => {
                addMessage(msg.sender, msg.message);
            });
        });
    };

    function addMessage(sender, message) {
        const messagesDiv = document.getElementById('messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message ' + (sender === 'user' ? 'user-message' : 'bot-message');
        msgDiv.textContent = `${sender}: ${message}`;
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        if (sender === 'bot') {
            lastBotResponse = message;
        }
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        if (message) {
            addMessage('user', message);
            fetch('/save-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                body: JSON.stringify({ sender: 'user', message: message })
            });

            fetch('/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                body: JSON.stringify({ query: message })
            })
            .then(response => response.json())
            .then(data => {
                addMessage('bot', data.response);
                fetch('/save-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({ sender: 'bot', message: data.response })
                });
            });
            input.value = '';
        }
    }

    function toggleVoiceInput() {
        const voiceBtn = document.getElementById('voice-btn');
        const voiceStatus = document.getElementById('voice-status');

        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('Sorry, your browser does not support speech recognition.');
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        if (!isListening) {
            recognition.start();
            isListening = true;
            voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            voiceStatus.textContent = 'Listening...';

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('message-input').value = transcript;
                voiceStatus.textContent = 'Heard: ' + transcript;
                sendMessage();
            };

            recognition.onend = function () {
                isListening = false;
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceStatus.textContent = '';
            };

            recognition.onerror = function (event) {
                voiceStatus.textContent = 'Error: ' + event.error;
                isListening = false;
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            };
        } else {
            recognition.stop();
            isListening = false;
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceStatus.textContent = '';
        }
    }

    function speakLastResponse() {
        if (!lastBotResponse) {
            alert('No bot response to speak.');
            return;
        }

        if (!('speechSynthesis' in window)) {
            alert('Sorry, your browser does not support text-to-speech.');
            return;
        }

        const utterance = new SpeechSynthesisUtterance(lastBotResponse);
        utterance.lang = 'en-US';
        window.speechSynthesis.speak(utterance);
    }

    function openSettings() {
        window.location.href = '/settings';
    }

    document.getElementById('message-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
{% endblock %}
